<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ‹–æ‹½åˆ†ç®±å·¥å…· (V52 - å…¨åŠŸèƒ½æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- å…¨å±€èˆ‡ä½ˆå±€ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; display: flex; height: 100vh; margin: 0; background-color: #f4f7f6; }
        .container { display: flex; width: 100%; padding: 20px; gap: 20px; }
        .panel { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #item-pool-container { flex: 1; }
        #bin-area-container { flex: 2; }
        h2 { text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin: 20px; }
        
        /* --- æ§åˆ¶é … --- */
        .controls { padding: 20px; border-bottom: 2px solid #eee; }
        textarea { width: calc(100% - 22px); height: 100px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 14px; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a77c81; cursor: not-allowed; }
        #export-btn { background-color: #28a745; }
        #export-btn:hover { background-color: #218838; }
        #export-a4-pdf-btn { background-color: #17a2b8; }
        #export-a4-pdf-btn:hover { background-color: #138496; }
        #export-a5-pdf-btn { background-color: #fd7e14; }
        #export-a5-pdf-btn:hover { background-color: #e86a02; }
        
        /* --- åˆ—è¡¨èˆ‡è¼¸å…¥æ¡† --- */
        .list-header { padding: 0 20px; }
        .list-header h2, #bin-area-title { display: flex; justify-content: space-between; align-items: center; }
        .item-count { background-color: #6c757d; color: white; font-size: 14px; padding: 2px 8px; border-radius: 10px; }
        #search-box, .order-input input, .command-group input { width: calc(100% - 22px); padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 10px; }
        .order-input, .command-group { padding: 20px 20px 0 20px; }
        .order-input label, .command-group label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px;}
        #item-list-content { flex-grow: 1; overflow-y: auto; padding: 20px; border: 2px dashed transparent; transition: border-color 0.2s, background-color 0.2s; }
        #bin-area { flex-grow: 1; overflow-y: auto; padding: 0 20px 20px 20px; }

        /* --- å•†å“èˆ‡ç®±å­é …ç›® --- */
        .item { background-color: #e9f7fd; border: 1px solid #bde0fe; border-radius: 4px; padding: 10px; margin-bottom: 10px; cursor: grab; user-select: none; transition: opacity 0.2s; }
        .item:active { cursor: grabbing; }
        .item.dragging { opacity: 0.5; }
        .item strong { color: #0d6efd; }
        .item .details { font-size: 12px; color: #555; }
        .bin { background-color: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; padding: 10px; margin-bottom: 20px; min-height: 100px; transition: background-color 0.2s, border-color 0.2s; }
        .bin h3 { margin: 0 0 10px 0; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .delete-bin-btn { color: #dc3545; cursor: pointer; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        .delete-bin-btn:hover { background-color: #f8d7da; }
        .bin .tracking-input { width: calc(100% - 22px); margin-top: 10px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; }
        .drag-over { background-color: #e2e6ea; border-color: #007bff; }
        
        /* --- å½ˆå‡ºè¦–çª— (Modal) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 300px; text-align: center; }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { width: 80%; padding: 8px; margin: 10px 0 20px 0; text-align: center; font-size: 18px; }

        /* --- Toast é€šçŸ¥ --- */
        .toast-notification { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        .toast-notification.show { opacity: 1; bottom: 30px; }
        .toast-notification.error { background-color: #dc3545; }
        .toast-notification.success { background-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <div id="item-pool-container" class="panel">
            <div class="order-input"><label for="order-number-input">è¨‚å–®è™Ÿç¢¼:</label><input type="text" id="order-number-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æœ¬æ¬¡ä½œæ¥­çš„è¨‚å–®è™Ÿç¢¼"></div>
            <div class="controls"><textarea id="data-input" placeholder="1. åœ¨æ­¤è²¼ä¸Šå•†å“è³‡æ–™..."></textarea><div class="button-group"><button id="parse-btn">è§£æè³‡æ–™</button></div></div>
            <div class="command-group"><label for="command-input">å¿«é€ŸæŒ‡ä»¤:</label><div style="display:flex; gap: 10px;"><input type="text" id="command-input" placeholder="è© æ•¸ ç®±è™Ÿ" style="margin-bottom:0; flex-grow:1;"><button id="execute-command-btn">åŸ·è¡Œ</button></div></div>
            <div class="list-header"><h2 id="pool-title">å¾…åˆ†ç®±å€</h2><input type="text" id="search-box" placeholder="ğŸ” åœ¨æ­¤é€éé—œéµå­—ç¯©é¸å•†å“ (å¯ç”¨ ã€ åˆ†éš”)" style="margin: 0 20px 10px 20px; width: calc(100% - 40px);"></div>
            <div id="item-list-content"></div>
        </div>
        <div id="bin-area-container" class="panel">
            <div class="controls" id="bin-controls">
                <div class="button-group">
                    <button id="add-bin-btn">æ–°å¢ç®±å­</button>
                    <button id="export-btn">åŒ¯å‡º CSV</button>
                    <button id="export-a4-pdf-btn">åŒ¯å‡º PDF (A4ç¸½è¡¨)</button>
                    <button id="export-a5-pdf-btn">åŒ¯å‡º PDF (A5ç®±è²¼)</button>
                </div>
            </div>
            <div id="bin-area-title-wrapper"></div>
            <div id="bin-area" class="bin-list"></div>
        </div>
    </div>
    <div id="quantity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ç¢ºèªæ•¸é‡</h3>
            <p>è¦å°‡å¤šå°‘æ•¸é‡çš„ "<span id="modal-item-name"></span>" æ”¾å…¥æ­¤ç®±ï¼Ÿ</p>
            <input type="number" id="modal-quantity-input" min="1">
            <div class="button-group" style="justify-content: center;">
                <button id="modal-confirm-btn">ç¢ºèª</button>
                <button id="modal-cancel-btn" style="background-color: #6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

<script>
    // --- DOM å…ƒç´ ç²å– ---
    const orderNumberInput = document.getElementById('order-number-input');
    const dataInput = document.getElementById('data-input');
    const parseBtn = document.getElementById('parse-btn');
    const addBinBtn = document.getElementById('add-bin-btn');
    const itemListContent = document.getElementById('item-list-content');
    const binArea = document.getElementById('bin-area');
    const searchBox = document.getElementById('search-box');
    const commandInput = document.getElementById('command-input');
    const executeCommandBtn = document.getElementById('execute-command-btn');
    const poolTitle = document.getElementById('pool-title');
    const binAreaTitleWrapper = document.getElementById('bin-area-title-wrapper');
    const binAreaTitle = document.createElement('h2');
    binAreaTitle.id = 'bin-area-title';
    binAreaTitleWrapper.appendChild(binAreaTitle);

    const quantityModal = document.getElementById('quantity-modal');
    const modalItemName = document.getElementById('modal-item-name');
    const modalQuantityInput = document.getElementById('modal-quantity-input');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    
    // AppState: ä»¥å•†å“ç·¨è™Ÿç‚º key
    let AppState = {
        pool: new Map(),
        bins: new Map()
    };
    let binCounter = 0;
    let currentSearchTerm = '';
    let modalCallback = null;

    // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---
    function render() {
        itemListContent.innerHTML = '';
        const searchKeywords = currentSearchTerm.split(/[,ã€\s]+/).filter(k => k);
        const itemsToRender = Array.from(AppState.pool.values()).filter(item => {
            if (!currentSearchTerm) return true;
            const itemText = `${item.name} ${item.code} ${item.barcode}`.toLowerCase();
            return searchKeywords.every(keyword => itemText.includes(keyword));
        });
        itemsToRender.forEach(item => {
            itemListContent.appendChild(createItemElement(item, 'pool'));
        });

        binArea.innerHTML = '';
        AppState.bins.forEach((binData, binId) => {
            const binEl = document.createElement('div');
            binEl.className = 'bin';
            binEl.dataset.binId = binId;

            const title = document.createElement('h3');
            title.innerHTML = `${binData.name} <span class="delete-bin-btn" title="åˆªé™¤æ­¤ç®±">[X]</span>`;

            const trackingInput = document.createElement('input');
            trackingInput.type = 'text';
            trackingInput.className = 'tracking-input';
            trackingInput.placeholder = 'è«‹åœ¨æ­¤è¼¸å…¥é‹å–®è™Ÿ...';
            trackingInput.value = binData.tracking;
            trackingInput.addEventListener('input', (e) => { 
                AppState.bins.get(binId).tracking = e.target.value; 
                saveStateToLocalStorage();
            });

            binEl.appendChild(title);

            binData.items.forEach(item => {
                binEl.appendChild(createItemElement(item, binId));
            });

            binEl.appendChild(trackingInput);
            binArea.appendChild(binEl);
        });

        updateCounts();
    }
    
    // --- æ ¸å¿ƒèˆ‡è¼”åŠ©å‡½å¼ ---
    function createItemElement(item, source) {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        itemEl.draggable = true;
        itemEl.dataset.code = item.code;
        itemEl.dataset.source = source;
        itemEl.innerHTML = `<strong>${item.name}</strong><div class="details">(ç·¨è™Ÿ: ${item.code}, æ¢ç¢¼: ${item.barcode}, æ•¸é‡: ${item.quantity})</div>`;
        return itemEl;
    }

    function updateCounts() {
        const poolTotal = Array.from(AppState.pool.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
        poolTitle.innerHTML = `å¾…åˆ†ç®±å€ <span class="item-count">${poolTotal}</span>`;
        
        let binsTotal = 0;
        AppState.bins.forEach((binData, binId) => {
            const binTotal = Array.from(binData.items.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
            binsTotal += binTotal;
            const binEl = binArea.querySelector(`.bin[data-bin-id="${binId}"]`);
            if (binEl) {
                const titleEl = binEl.querySelector('h3');
                if (titleEl){
                    const deleteBtnHTML = titleEl.querySelector('.delete-bin-btn')?.outerHTML || '';
                    titleEl.innerHTML = `${binData.name} <span class="item-count">${binTotal}</span> ${deleteBtnHTML}`;
                }
            }
        });
        binAreaTitle.innerHTML = `åˆ†ç®±å·¥ä½œå€ <span class="item-count">${binsTotal}</span>`;
    }

    function moveItem(itemCode, sourceId, targetId, quantityToMove) {
        const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId)?.items;
        const targetMap = (targetId === 'pool') ? AppState.pool : AppState.bins.get(targetId)?.items;

        if (!sourceMap || !targetMap || !sourceMap.has(itemCode)) { return; }

        const itemToMove = sourceMap.get(itemCode);
        const existingTargetItem = targetMap.get(itemCode);

        if (existingTargetItem) {
            existingTargetItem.quantity += quantityToMove;
        } else {
            targetMap.set(itemCode, { ...itemToMove, quantity: quantityToMove });
        }

        itemToMove.quantity -= quantityToMove;
        if (itemToMove.quantity <= 0) {
            sourceMap.delete(itemCode);
        }

        render();
        saveStateToLocalStorage();
    }
    
    function returnItemsToPool(items) {
        items.forEach(itemToReturn => {
            const existingPoolItem = AppState.pool.get(itemToReturn.code);
            if (existingPoolItem) {
                existingPoolItem.quantity += itemToReturn.quantity;
            } else {
                AppState.pool.set(itemToReturn.code, { ...itemToReturn });
            }
        });
    }

    function reIndexBins() {
        const newBins = new Map();
        let newCounter = 1;
        const sortedBinArray = Array.from(AppState.bins.entries()).sort((a, b) => {
            const numA = parseInt(a[0].split('-')[1]);
            const numB = parseInt(b[0].split('-')[1]);
            return numA - numB;
        });

        sortedBinArray.forEach(([oldBinId, binData]) => {
            const newBinId = `bin-${newCounter}`;
            binData.name = `ç¬¬ ${newCounter} ç®±`;
            newBins.set(newBinId, binData);
            newCounter++;
        });
        AppState.bins = newBins;
        binCounter = newBins.size;
    }
    
    function showQuantityModal(item, sourceId, targetId) {
        modalItemName.textContent = item.name;
        modalQuantityInput.value = item.quantity;
        modalQuantityInput.max = item.quantity;
        quantityModal.style.display = 'flex';
        modalQuantityInput.focus();
        modalCallback = (amount) => {
            moveItem(item.code, sourceId, targetId, amount);
            modalCallback = null;
        };
    }

    function hideQuantityModal() {
        quantityModal.style.display = 'none';
        modalCallback = null;
    }

    function intelligentParse(rawLines) {
        const poolMap = new Map();
        const isNumeric = (str) => str && !isNaN(str) && !isNaN(parseFloat(str));
        const headers = new Set(["å•†å“ç·¨è™Ÿ", "åœ‹éš›æ¢ç¢¼", "å“é …åç¨±", "æ•¸é‡", "æ’¿å®Œå‰©"]);
        let dataLines = rawLines
            .map(line => line.trim())
            .filter(line => line && line !== 'åœ–' && !headers.has(line));

        let i = 0; 
        while (i < dataLines.length) {
            let item = null;
            if (i + 4 < dataLines.length && !isNumeric(dataLines[i + 2]) && isNumeric(dataLines[i + 3]) && isNumeric(dataLines[i + 4])) {
                item = {
                    code: dataLines[i],
                    barcode: dataLines[i + 1] || 'NA',
                    name: dataLines[i + 2],
                    quantity: parseInt(dataLines[i + 3]) || 0
                };
                i += 5;
            } else if (i + 3 < dataLines.length && !isNumeric(dataLines[i + 1]) && isNumeric(dataLines[i + 2]) && isNumeric(dataLines[i + 3])) {
                item = {
                    code: dataLines[i],
                    barcode: 'NA',
                    name: dataLines[i + 1],
                    quantity: parseInt(dataLines[i + 2]) || 0
                };
                i += 4;
            } else {
                i++;
            }

            if (item) {
                if (poolMap.has(item.code)) {
                    poolMap.get(item.code).quantity += item.quantity;
                } else {
                    poolMap.set(item.code, item);
                }
            }
        }
        return poolMap;
    }

    // --- äº‹ä»¶ç›£è½å™¨ç¶å®š ---
    parseBtn.addEventListener('click', () => {
        const rawLines = dataInput.value.trim().split('\n');
        const parsedMap = intelligentParse(rawLines);
        if (parsedMap.size > 0) {
            AppState.pool = parsedMap;
            AppState.bins.clear();
            binCounter = 0;
            render();
            dataInput.value = '';
            showToast('è³‡æ–™è§£ææˆåŠŸï¼', 'success');
            saveStateToLocalStorage();
        } else {
            showToast("è§£æå¤±æ•—ï¼è«‹æª¢æŸ¥è³‡æ–™æ ¼å¼ã€‚", 'error');
        }
    });

    addBinBtn.addEventListener('click', () => {
        binCounter++;
        const binId = `bin-${binCounter}`;
        AppState.bins.set(binId, { name: `ç¬¬ ${binCounter} ç®±`, tracking: '', items: new Map() });
        render();
        saveStateToLocalStorage();
    });

    searchBox.addEventListener('input', () => {
        currentSearchTerm = searchBox.value.trim().toLowerCase();
        render();
    });

    binArea.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-bin-btn')) {
            const binEl = e.target.closest('.bin');
            if (!binEl) return;
            const binId = binEl.dataset.binId;
            const binData = AppState.bins.get(binId);
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${binData.name}ã€å—ï¼Ÿ\n(ç®±å…§æ‰€æœ‰å•†å“å°‡æœƒè¢«ç§»å›å¾…åˆ†ç®±å€)`)) {
                if (binData.items.size > 0) {
                    returnItemsToPool(Array.from(binData.items.values()));
                }
                AppState.bins.delete(binId);
                reIndexBins();
                render();
                saveStateToLocalStorage();
            }
        }
    });
    
    // --- æ‹–æ‹½äº‹ä»¶ ---
    document.addEventListener('dragstart', e => {
        const itemEl = e.target.closest('.item');
        if (itemEl) {
            const itemInfo = {
                code: itemEl.dataset.code,
                source: itemEl.dataset.source
            };
            e.dataTransfer.setData('application/json', JSON.stringify(itemInfo));
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => itemEl.classList.add('dragging'), 0);
        }
    });
    document.addEventListener('dragend', e => { const el = e.target.closest('.item'); if(el) el.classList.remove('dragging'); });
    document.addEventListener('dragover', e => { e.preventDefault(); const targetBin = e.target.closest('.bin'); if (targetBin) { targetBin.classList.add('drag-over'); } });
    document.addEventListener('dragleave', e => { const targetBin = e.target.closest('.bin'); if (targetBin) { targetBin.classList.remove('drag-over'); } });
    
    document.addEventListener('drop', e => {
        e.preventDefault();
        const targetBinEl = e.target.closest('.bin');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        
        try {
            const itemInfo = JSON.parse(e.dataTransfer.getData('application/json'));
            if (!itemInfo) return;

            if (targetBinEl && itemInfo.source === 'pool') {
                const targetBinId = targetBinEl.dataset.binId;
                const itemData = AppState.pool.get(itemInfo.code);
                if (!itemData) return;

                if (itemData.quantity > 1) {
                    showQuantityModal(itemData, itemInfo.source, targetBinId);
                } else {
                    moveItem(itemInfo.code, itemInfo.source, targetBinId, 1);
                }
            }
        } catch (err) {
            console.error("æ‹–æ›³è³‡æ–™è§£æå¤±æ•—:", err);
        }
    });
    
    modalConfirmBtn.addEventListener('click', () => {
        const amount = parseInt(modalQuantityInput.value);
        const maxAmount = parseInt(modalQuantityInput.max);
        const callbackToExecute = modalCallback;
        if (amount > 0 && amount <= maxAmount) {
            hideQuantityModal();
            if (callbackToExecute) callbackToExecute(amount);
        } else {
            showToast(`è«‹è¼¸å…¥ 1 åˆ° ${maxAmount} ä¹‹é–“çš„æœ‰æ•ˆæ•¸é‡ï¼`, 'error');
        }
    });
    modalCancelBtn.addEventListener('click', hideQuantityModal);

    // --- å¿«é€ŸæŒ‡ä»¤ ---
    function processCommand(commandText) {
        const tokens = commandText.trim().split(/\s+/);
        if (tokens.length < 3) { showToast("æŒ‡ä»¤æ ¼å¼éŒ¯èª¤ï¼æ‡‰ç‚ºï¼šé—œéµå­— æ•¸é‡ ç®±è™Ÿ", 'error'); return false; }
        const binNumStr = tokens.pop();
        const quantityStr = tokens.pop();
        const searchTerm = tokens.join(' ');
        if(parseInt(binNumStr) === 0){ showToast("æŒ‡ä»¤éŒ¯èª¤ï¼šç›®çš„åœ°ä¸èƒ½ç‚º 0 (å¾…åˆ†ç®±å€)ã€‚", 'error'); return false; }
        const quantityToMove = parseInt(quantityStr);
        const binId = `bin-${binNumStr}`;
        if (isNaN(quantityToMove)) { showToast("æŒ‡ä»¤éŒ¯èª¤ï¼šæ•¸é‡å¿…é ˆæ˜¯æ•¸å­—ï¼", 'error'); return false; }
        const targetBin = AppState.bins.get(binId);
        if (!targetBin) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç®±è™Ÿ ${binNumStr}ï¼`, 'error'); return false; }
        
        const searchLower = searchTerm.toLowerCase();
        const targetItem = Array.from(AppState.pool.values()).find(item => 
            item.name.toLowerCase().includes(searchLower) || 
            item.code.toLowerCase().includes(searchLower) || 
            item.barcode.toLowerCase().includes(searchLower)
        );

        if (!targetItem) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šåœ¨å¾…åˆ†ç®±å€æ‰¾ä¸åˆ°ç¬¦åˆ "${searchTerm}" çš„å•†å“ï¼`, 'error'); return false; }
        const availableAmount = targetItem.quantity;
        if (quantityToMove <= 0 || quantityToMove > availableAmount) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šç§»å‹•æ•¸é‡ (${quantityToMove}) ç„¡æ•ˆæˆ–è¶…éå‰©é¤˜æ•¸é‡ (${availableAmount})ï¼`, 'error'); return false; }
        
        moveItem(targetItem.code, 'pool', binId, quantityToMove);
        return true;
    }
    executeCommandBtn.addEventListener('click', () => { if (processCommand(commandInput.value)) { commandInput.value = ''; } });
    
    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    function setupExports() {
        const exportBtn = document.getElementById('export-btn');
        const exportA4PdfBtn = document.getElementById('export-a4-pdf-btn');
        const exportA5PdfBtn = document.getElementById('export-a5-pdf-btn');

        function generateExportFilename(extension) {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const orderNumber = orderNumberInput.value.trim() || 'NoOrder';
            return `${orderNumber}_${hh}${mm}${ss}_packing_list${extension}`;
        }

        function exportCSV() {
            if (AppState.bins.size === 0) {
                showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error");
                return;
            }
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
            let csvContent = "\uFEFF";
            csvContent += "è¨‚å–®è™Ÿç¢¼,ç®±è™Ÿ,é‹å–®è™Ÿ,å•†å“ç·¨è™Ÿ,åœ‹éš›æ¢ç¢¼,å“é …åç¨±,æ•¸é‡\n";
            
            const formatAsExcelText = (value) => {
                if (!value && value !== 0) return '';
                return `="\\t${String(value).replace(/"/g, '""')}"`;
            };

            AppState.bins.forEach(binData => {
                if (binData.items.size === 0) {
                    const row = [orderNumber, binData.name, binData.tracking, '', '', '"æ­¤ç®±ç„¡å•†å“"', 0].join(',');
                    csvContent += row + "\n";
                } else {
                    binData.items.forEach(item => {
                        const row = [
                            orderNumber, binData.name, binData.tracking,
                            formatAsExcelText(item.code), formatAsExcelText(item.barcode),
                            `"${item.name.replace(/"/g, '""')}"`, item.quantity
                        ].join(',');
                        csvContent += row + "\n";
                    });
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = generateExportFilename('.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportA4PDF() {
            if (AppState.bins.size === 0 && AppState.pool.size === 0) { 
                showToast("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; 
            }
            const btn = document.getElementById('export-a4-pdf-btn');
            btn.disabled = true; btn.textContent = 'æ­£åœ¨ç”¢ç”Ÿ...';
            
            const poolTotal = Array.from(AppState.pool.values()).reduce((sum, item) => sum + item.quantity, 0);
            let binsTotal = 0;
            AppState.bins.forEach(binData => {
                binsTotal += Array.from(binData.items.values()).reduce((sum, item) => sum + item.quantity, 0);
            });
            const orderTotal = poolTotal + binsTotal;
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
            const exportDate = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            let contentHTML = `<style>body{font-family:'Helvetica','Arial','Microsoft JhengHei',sans-serif;font-size:10px;}.pdf-container{margin:20px;}.pdf-header{margin-bottom:20px;border-bottom:2px solid #ccc;padding-bottom:10px;}.pdf-header h1{margin:0;font-size:24px;}.pdf-header p{margin:5px 0 0;font-size:12px;}.pdf-bin{border:1px solid #eee;border-radius:8px;padding:15px;margin-bottom:20px;page-break-inside:avoid;}.pdf-bin h2{margin:0 0 10px;font-size:16px;border-bottom:1px solid #f0f0f0;padding-bottom:5px;}.pdf-bin p{font-size:12px;}table{width:100%;border-collapse:collapse;margin-top:10px;}th,td{border:1px solid #ddd;padding:6px;text-align:left;word-break:break-all;}th{background-color:#f8f8f8;font-weight:bold;}</style><div class="pdf-container"><div class="pdf-header"><h1>åˆ†ç®±æ˜ç´°ç¸½è¡¨</h1><p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p><p><strong>åŒ¯å‡ºæ—¥æœŸ:</strong> ${exportDate}</p><p><strong>è¨‚å–®ç¸½æ•¸:</strong> ${orderTotal} ä»¶</p><p><strong>å·²åˆ†ç®±ç¸½æ•¸:</strong> ${binsTotal} ä»¶</p></div>`;
            
            AppState.bins.forEach((binData, binId) => {
                contentHTML += `<div class="pdf-bin"><h2>${binData.name}</h2><p><strong>é‹å–®è™Ÿ:</strong> ${binData.tracking || 'æœªå¡«å¯«'}</p><table><thead><tr><th style="width: 40%;">å“é …åç¨±</th><th style="width: 25%;">å•†å“ç·¨è™Ÿ</th><th style="width: 25%;">åœ‹éš›æ¢ç¢¼</th><th style="width: 10%;">æ•¸é‡</th></tr></thead><tbody>`;
                if (binData.items.size > 0) {
                    binData.items.forEach(item => { contentHTML += `<tr><td>${item.name}</td><td>${item.code}</td><td>${item.barcode}</td><td>${item.quantity}</td></tr>`; });
                } else {
                    contentHTML += `<tr><td colspan="4" style="text-align:center;">æ­¤ç®±ç„¡å•†å“</td></tr>`;
                }
                contentHTML += `</tbody></table></div>`;
            });
            
            contentHTML += '</div>';
            const element = document.createElement('div');
            element.innerHTML = contentHTML;
            const opt = { margin: 0.5, filename: generateExportFilename('.pdf'), image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save().then(() => { btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A4ç¸½è¡¨)'; });
        }

        function exportA5BoxLabelsPDF() {
            if (AppState.bins.size === 0) { 
                showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; 
            }
            const btn = document.getElementById('export-a5-pdf-btn');
            btn.disabled = true; btn.textContent = 'æ­£åœ¨ç”¢ç”Ÿ...';
            
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
            let contentHTML = ``;
            const pageStyles = `<style> * { box-sizing: border-box; } html, body { margin: 0; padding: 0; font-family: 'Helvetica', 'Arial', 'Microsoft JhengHei', sans-serif; } .a5-label-page { width: 210mm; height: 148.5mm; padding: 8mm; display: flex; flex-direction: column; page-break-after: always; } .a5-label-page:last-child { page-break-after: auto; } .header, .footer { flex-shrink: 0; text-align: center; } .header h1 { margin: 0 0 5px 0; font-size: 26px; } .header p { margin: 0; font-size: 16px; } .content { flex-grow: 1; overflow: hidden; margin-top: 5px; } .content table { width: 100%; border-collapse: collapse; } .content th, .content td { border: 1px solid #ccc; padding: 4px; text-align: left; font-size: 12px; line-height: 1.3; } .content th { background-color: #f2f2f2; } .footer { margin-top: 10px; } .footer h2 { margin: 5px 0 0 0; font-size: 20px; } .footer p { font-size: 14px; margin: 3px 0; } </style>`;

            const binsArray = Array.from(AppState.bins.values());
            binsArray.forEach((binData) => {
                const itemsArray = Array.from(binData.items.values());
                const binTotal = itemsArray.reduce((sum, item) => sum + item.quantity, 0);
                const chunkSize = 10;
                const totalPagesForBin = Math.max(1, Math.ceil(itemsArray.length / chunkSize));

                for (let i = 0; i < totalPagesForBin; i++) {
                    const itemChunk = itemsArray.slice(i * chunkSize, (i + 1) * chunkSize);
                    
                    contentHTML += `<div class="a5-label-page"><div class="header"><h1>${binData.name} (${i + 1}/${totalPagesForBin})</h1><p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p></div><div class="content"><table><thead><tr><th style="width: 80%;">å“é …åç¨±</th><th>æ•¸é‡</th></tr></thead><tbody>`;
                    if (itemChunk.length > 0) {
                        itemChunk.forEach(item => {
                            contentHTML += `<tr><td>${item.name}</td><td style="text-align:center;">${item.quantity}</td></tr>`;
                        });
                    } else {
                        contentHTML += `<tr><td colspan="2" style="text-align:center; height: 50mm;">æ­¤ç®±ç„¡å•†å“</td></tr>`;
                    }
                    contentHTML += `</tbody></table></div><div class="footer"><p><strong>æœ¬ç®±ç¸½æ•¸: ${binTotal} ä»¶</strong></p><h2><strong>é‹å–®è™Ÿ:</strong> ${binData.tracking || '___________________'}</h2><p>ç°½æ”¶/ç¢ºèª: ___________________</p></div></div>`;
                }
            });

            const element = document.createElement('div');
            element.innerHTML = pageStyles + contentHTML;
            const opt = { margin: 0, filename: generateExportFilename('_labels.pdf'), image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a5', orientation: 'landscape' } };
            html2pdf().set(opt).from(element).save().then(() => { btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A5ç®±è²¼)'; });
        }

        exportBtn.addEventListener('click', exportCSV);
        exportA4PdfBtn.addEventListener('click', exportA4PDF);
        exportA5PdfBtn.addEventListener('click', exportA5BoxLabelsPDF);
    }
    setupExports();

    // --- UX å„ªåŒ–ï¼šéé˜»å¡å¼ Toast é€šçŸ¥ ---
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // --- åŠŸèƒ½å‡ç´šï¼šä½¿ç”¨ localStorage è‡ªå‹•ä¿å­˜èˆ‡è¼‰å…¥ç‹€æ…‹ ---
    function saveStateToLocalStorage() {
        try {
            const stateToSave = {
                pool: Array.from(AppState.pool.entries()),
                bins: Array.from(AppState.bins.entries()).map(([binId, binData]) => {
                    return [binId, { ...binData, items: Array.from(binData.items.entries()) }];
                }),
                binCounter: binCounter,
                orderNumber: orderNumberInput.value,
            };
            localStorage.setItem('binningToolState_v52', JSON.stringify(stateToSave));
        } catch (e) {
            console.error("ç„¡æ³•å„²å­˜ç‹€æ…‹:", e);
            showToast("ç„¡æ³•å„²å­˜é€²åº¦ï¼Œå¯èƒ½å„²å­˜ç©ºé–“å·²æ»¿ã€‚", "error");
        }
    }

    function loadStateFromLocalStorage() {
        const savedStateJSON = localStorage.getItem('binningToolState_v52');
        if (!savedStateJSON) return;
        try {
            const savedState = JSON.parse(savedStateJSON);
            AppState.pool = new Map(savedState.pool);
            AppState.bins = new Map(savedState.bins.map(([binId, binData]) => {
                return [binId, { ...binData, items: new Map(binData.items) }];
            }));
            binCounter = savedState.binCounter || 0;
            orderNumberInput.value = savedState.orderNumber || '';
            render();
            showToast("å·²æˆåŠŸè¼‰å…¥ä¸Šæ¬¡çš„é€²åº¦ã€‚", 'success');
        } catch(e) {
            console.error("è¼‰å…¥ç‹€æ…‹å¤±æ•—:", e);
            showToast("è¼‰å…¥èˆŠé€²åº¦å¤±æ•—ï¼Œå¯èƒ½æ˜¯è³‡æ–™æ ¼å¼å·²æ›´æ–°ã€‚", "error");
            localStorage.removeItem('binningToolState_v52');
        }
    }
    
    // --- åˆå§‹å‘¼å« ---
    orderNumberInput.addEventListener('input', saveStateToLocalStorage);
    document.addEventListener('DOMContentLoaded', loadStateFromLocalStorage);

</script>
</body>
</html>
