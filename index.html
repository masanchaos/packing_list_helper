<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>æ™ºæ…§æ‹–æ‹½åˆ†ç®±å·¥å…· (V77 - æ™ºæ…§è¨ˆç®—ç‰ˆ)</title>
Â  Â  <style>
Â  Â  Â  Â  /* --- å…¨å±€èˆ‡ä½ˆå±€ --- */
Â  Â  Â  Â  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; display: flex; height: 100vh; margin: 0; background-color: #f4f7f6; }
Â  Â  Â  Â  .container { display: flex; width: 100%; padding: 20px; gap: 20px; }
Â  Â  Â  Â  .panel { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
Â  Â  Â  Â  #item-pool-container { flex: 1; }
Â  Â  Â  Â  #bin-area-container { flex: 2; }
Â  Â  Â  Â  h2 { text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin: 20px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- æ§åˆ¶é … --- */
Â  Â  Â  Â  .controls { padding: 20px; border-bottom: 2px solid #eee; }
Â  Â  Â  Â  textarea { width: calc(100% - 22px); height: 100px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 14px; }
Â  Â  Â  Â  .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
Â  Â  Â  Â  button { padding: 10px 15px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
Â  Â  Â  Â  button:hover { background-color: #0056b3; }
Â  Â  Â  Â  button:disabled { background-color: #a77c81; cursor: not-allowed; }
Â  Â  Â  Â  #export-btn { background-color: #28a745; }
Â  Â  Â  Â  #export-btn:hover { background-color: #218838; }
Â  Â  Â  Â  #export-a4-pdf-btn { background-color: #17a2b8; }
Â  Â  Â  Â  #export-a4-pdf-btn:hover { background-color: #138496; }
Â  Â  Â  Â  #export-a5-pdf-btn { background-color: #fd7e14; }
Â  Â  Â  Â  #export-a5-pdf-btn:hover { background-color: #e86a02; }
Â  Â  Â  Â  #export-thermal-pdf-btn { background-color: #6f42c1; }
Â  Â  Â  Â  #export-thermal-pdf-btn:hover { background-color: #5a359a; }
Â  Â  Â  Â  #clear-data-btn { background-color: #dc3545; }
Â  Â  Â  Â  #clear-data-btn:hover { background-color: #c82333; }
Â  Â  Â  Â  #quick-add-bins-btn { background-color: #20c997; }
Â  Â  Â  Â  #quick-add-bins-btn:hover { background-color: #1baa80; }

Â  Â  Â  Â  /* --- åˆ—è¡¨èˆ‡è¼¸å…¥æ¡† --- */
Â  Â  Â  Â  .list-header { padding: 0 20px; }
Â  Â  Â  Â  .list-header h2, #bin-area-title { display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .item-count { background-color: #6c757d; color: white; font-size: 14px; padding: 2px 8px; border-radius: 10px; }
Â  Â  Â  Â  #search-box, .order-input input, .command-group input { width: calc(100% - 22px); padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 10px; }
Â  Â  Â  Â  .order-input, .command-group { padding: 20px 20px 0 20px; }
Â  Â  Â  Â  .order-input label, .command-group label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px;}
Â  Â  Â  Â  #item-list-content { flex-grow: 1; overflow-y: auto; padding: 20px; border: 2px dashed transparent; transition: border-color 0.2s, background-color 0.2s; }
Â  Â  Â  Â  #bin-area { flex-grow: 1; overflow-y: auto; padding: 0 20px 20px 20px; }

Â  Â  Â  Â  /* --- å•†å“èˆ‡ç®±å­é …ç›® --- */
Â  Â  Â  Â  .item { background-color: #e9f7fd; border: 1px solid #bde0fe; border-radius: 4px; padding: 10px; margin-bottom: 10px; cursor: grab; user-select: none; transition: opacity 0.2s; }
Â  Â  Â  Â  .item:active { cursor: grabbing; }
Â  Â  Â  Â  .item.dragging { opacity: 0.5; }
Â  Â  Â  Â  .item strong { color: #0d6efd; }
Â  Â  Â  Â  .item .details { font-size: 12px; color: #555; }
Â  Â  Â  Â  .bin { background-color: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; padding: 10px; margin-bottom: 20px; min-height: 100px; transition: background-color 0.2s, border-color 0.2s; }
Â  Â  Â  Â  .bin h3 { margin: 0 0 10px 0; color: #666; display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .delete-bin-btn { color: #dc3545; cursor: pointer; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
Â  Â  Â  Â  .delete-bin-btn:hover { background-color: #f8d7da; }
Â  Â  Â  Â  .bin .tracking-input { width: calc(100% - 22px); margin-bottom: 10px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; }
Â  Â  Â  Â  .drag-over { background-color: #e2e6ea; border-color: #007bff !important; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- å½ˆå‡ºè¦–çª— (Modal) --- */
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
Â  Â  Â  Â  .modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 350px; text-align: center; }
Â  Â  Â  Â  .modal-content h3 { margin-top: 0; }
Â  Â  Â  Â  .modal-content input { width: 80%; padding: 8px; margin: 10px 0 20px 0; text-align: center; font-size: 18px; }

Â  Â  Â  Â  /* --- Toast é€šçŸ¥ --- */
Â  Â  Â  Â  .toast-notification { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
Â  Â  Â  Â  .toast-notification.show { opacity: 1; bottom: 30px; }
Â  Â  Â  Â  .toast-notification.error { background-color: #dc3545; }
Â  Â  Â  Â  .toast-notification.success { background-color: #28a745; }

Â  Â  Â  Â  /* --- é¸æ“‡è¦–çª—æ¨£å¼ --- */
Â  Â  Â  Â  #choice-list .choice-item {
Â  Â  Â  Â  Â  Â  padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px; cursor: pointer; text-align: left; transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #choice-list .choice-item:hover { background-color: #f0f8ff; }
Â  Â  Â  Â  #choice-list .choice-item .details { font-size: 12px; color: #555; margin-top: 4px; }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <div id="item-pool-container" class="panel">
Â  Â  Â  Â  Â  Â  <div class="order-input"><label for="order-number-input">è¨‚å–®è™Ÿç¢¼:</label><input type="text" id="order-number-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æœ¬æ¬¡ä½œæ¥­çš„è¨‚å–®è™Ÿç¢¼"></div>
Â  Â  Â  Â  Â  Â  <div class="controls"><textarea id="data-input" placeholder="1. åœ¨æ­¤è²¼ä¸Šå•†å“è³‡æ–™..."></textarea><div class="button-group"><button id="parse-btn">è§£æè³‡æ–™</button><button id="clear-data-btn">æ¸…é™¤å…¨éƒ¨è³‡æ–™</button></div></div>
Â  Â  Â  Â  Â  Â  <div class="command-group"><label for="command-input">å¿«é€ŸæŒ‡ä»¤:</label><div style="display:flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="command-input" placeholder="è© æ•¸ [ä¾†æºç®±] å»å‘ç®±(0=å¾…åˆ†ç®±å€)" style="margin-bottom:0; flex-grow:1;" title="ç¯„ä¾‹:&#10;å¾å¾…åˆ†ç®±å€ç§»å‡º: 'å•†å“A 5 1' (5å€‹å•†å“Aç§»åˆ°ç¬¬1ç®±)&#10;å¾ç®±å­ç§»å›å¾…åˆ†ç®±å€: 'å•†å“A 3 2 0' (3å€‹å•†å“Aå¾ç¬¬2ç®±ç§»å›)&#10;ç®±å­ä¹‹é–“ç§»å‹•: 'å•†å“A 2 1 3' (2å€‹å•†å“Aå¾ç¬¬1ç®±ç§»åˆ°ç¬¬3ç®±)">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="execute-command-btn">åŸ·è¡Œ</button>
Â  Â  Â  Â  Â  Â  </div></div>
Â  Â  Â  Â  Â  Â  <div class="list-header"><h2 id="pool-title">å¾…åˆ†ç®±å€</h2><input type="text" id="search-box" placeholder="ğŸ” åœ¨æ­¤é€éé—œéµå­—ç¯©é¸å•†å“ (å¯ç”¨ ã€ åˆ†éš”)" style="margin: 0 20px 10px 20px; width: calc(100% - 40px);"></div>
Â  Â  Â  Â  Â  Â  <div id="item-list-content"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="bin-area-container" class="panel">
Â  Â  Â  Â  Â  Â  <div class="controls" id="bin-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-bin-btn">æ–°å¢ç®±å­</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="quick-add-bins-btn">å¿«é€Ÿç”Ÿæˆå¤šç®±</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-btn">åŒ¯å‡º CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-a4-pdf-btn">åŒ¯å‡º PDF (A4ç¸½è¡¨)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-a5-pdf-btn">åŒ¯å‡º PDF (A5ç®±è²¼)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-thermal-pdf-btn">åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="bin-area-title-wrapper"></div>
Â  Â  Â  Â  Â  Â  <div id="bin-area" class="bin-list"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="quantity-modal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3 id="modal-title">ç¢ºèªæ•¸é‡</h3>
Â  Â  Â  Â  Â  Â  <p>è¦å°‡å¤šå°‘æ•¸é‡çš„ "<span id="modal-item-name"></span>" æ”¾å…¥æ­¤ç®±ï¼Ÿ</p>
Â  Â  Â  Â  Â  Â  <input type="number" id="modal-quantity-input" min="1">
Â  Â  Â  Â  Â  Â  <div class="button-group" style="justify-content: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-confirm-btn">ç¢ºèª</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-cancel-btn" style="background-color: #6c757d;">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="choice-modal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3>ç™¼ç¾å¤šå€‹ç¬¦åˆé …ç›®</h3>
Â  Â  Â  Â  Â  Â  <p>è«‹é¸æ“‡æ‚¨è¦æ“ä½œçš„ç¢ºåˆ‡å•†å“ï¼š</p>
Â  Â  Â  Â  Â  Â  <div id="choice-list" style="max-height: 200px; overflow-y: auto; margin: 15px 0;"></div>
Â  Â  Â  Â  Â  Â  <button id="choice-cancel-btn" style="background-color: #6c757d; margin-top: 10px; width: 100%;">å–æ¶ˆ</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

<script>
Â  Â  // --- DOM å…ƒç´ ç²å– ---
Â  Â  const orderNumberInput = document.getElementById('order-number-input');
Â  Â  const dataInput = document.getElementById('data-input');
Â  Â  const parseBtn = document.getElementById('parse-btn');
Â  Â  const addBinBtn = document.getElementById('add-bin-btn');
Â  Â  const clearDataBtn = document.getElementById('clear-data-btn');
Â  Â  const quickAddBinsBtn = document.getElementById('quick-add-bins-btn');
Â  Â  const itemListContent = document.getElementById('item-list-content');
Â  Â  const binArea = document.getElementById('bin-area');
Â  Â  const searchBox = document.getElementById('search-box');
Â  Â  const commandInput = document.getElementById('command-input');
Â  Â  const executeCommandBtn = document.getElementById('execute-command-btn');
Â  Â  const poolTitle = document.getElementById('pool-title');
Â  Â  const binAreaTitleWrapper = document.getElementById('bin-area-title-wrapper');
Â  Â  const binAreaTitle = document.createElement('h2');
Â  Â  binAreaTitle.id = 'bin-area-title';
Â  Â  binAreaTitleWrapper.appendChild(binAreaTitle);
Â  Â  const quantityModal = document.getElementById('quantity-modal');
Â  Â  const modalItemName = document.getElementById('modal-item-name');
Â  Â  const modalQuantityInput = document.getElementById('modal-quantity-input');
Â  Â  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
Â  Â  const modalCancelBtn = document.getElementById('modal-cancel-btn');
Â  Â  const choiceModal = document.getElementById('choice-modal');
Â  Â  const choiceList = document.getElementById('choice-list');
Â  Â  const choiceCancelBtn = document.getElementById('choice-cancel-btn');
Â  Â Â 
Â  Â  let AppState = { pool: new Map(), bins: new Map() };
Â  Â  let binCounter = 0;
Â  Â  let currentSearchTerm = '';
Â  Â  let modalCallback = null;

Â  Â  // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---
Â  Â  function render() {
Â  Â  Â  Â  itemListContent.innerHTML = '';
Â  Â  Â  Â  const searchKeywords = currentSearchTerm.split(/[,ã€\s]+/).filter(Boolean);
Â  Â  Â  Â  const itemsToRender = Array.from(AppState.pool.values()).filter(item => {
Â  Â  Â  Â  Â  Â  if (searchKeywords.length === 0) return true;
Â  Â  Â  Â  Â  Â  const itemText = `${item.name} ${item.code} ${item.barcode}`.toLowerCase();
Â  Â  Â  Â  Â  Â  return searchKeywords.some(keyword => itemText.includes(keyword));
Â  Â  Â  Â  });
Â  Â  Â  Â  itemsToRender.forEach(item => { itemListContent.appendChild(createItemElement(item, 'pool')); });
Â  Â  Â  Â  binArea.innerHTML = '';
Â  Â  Â  Â  AppState.bins.forEach((binData, binId) => {
Â  Â  Â  Â  Â  Â  const binEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  binEl.className = 'bin';
Â  Â  Â  Â  Â  Â  binEl.dataset.binId = binId;
Â  Â  Â  Â  Â  Â  const title = document.createElement('h3');
Â  Â  Â  Â  Â  Â  title.innerHTML = `${binData.name} <span class="delete-bin-btn" title="åˆªé™¤æ­¤ç®±">[X]</span>`;
Â  Â  Â  Â  Â  Â  const trackingInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  trackingInput.type = 'text';
Â  Â  Â  Â  Â  Â  trackingInput.className = 'tracking-input';
Â  Â  Â  Â  Â  Â  trackingInput.placeholder = 'è«‹åœ¨æ­¤è¼¸å…¥é‹å–®è™Ÿ...';
Â  Â  Â  Â  Â  Â  trackingInput.value = binData.tracking;
Â  Â  Â  Â  Â  Â  trackingInput.addEventListener('input', (e) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  AppState.bins.get(binId).tracking = e.target.value;Â 
Â  Â  Â  Â  Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  binEl.appendChild(title);
Â  Â  Â  Â  Â  Â  binEl.appendChild(trackingInput);
Â  Â  Â  Â  Â  Â  binData.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  binEl.appendChild(createItemElement(item, binId));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  binArea.appendChild(binEl);
Â  Â  Â  Â  });
Â  Â  Â  Â  updateCounts();
Â  Â  }
Â  Â Â 
Â  Â  // --- æ ¸å¿ƒèˆ‡è¼”åŠ©å‡½å¼ ---
Â  Â  function createItemElement(item, source) {
Â  Â  Â  Â  const itemEl = document.createElement('div');
Â  Â  Â  Â  itemEl.className = 'item';
Â  Â  Â  Â  itemEl.draggable = true;
Â  Â  Â  Â  itemEl.dataset.code = item.code;
Â  Â  Â  Â  itemEl.dataset.source = source;
Â  Â  Â  Â  itemEl.innerHTML = `<strong>${item.name}</strong><div class="details">(ç·¨è™Ÿ: ${item.code}, æ¢ç¢¼: ${item.barcode}, æ•¸é‡: ${item.quantity})</div>`;
Â  Â  Â  Â  return itemEl;
Â  Â  }

Â  Â  function updateCounts() {
Â  Â  Â  Â  const poolTotal = Array.from(AppState.pool.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
Â  Â  Â  Â  poolTitle.innerHTML = `å¾…åˆ†ç®±å€ <span class="item-count">${poolTotal}</span>`;
Â  Â  Â  Â  let binsTotal = 0;
Â  Â  Â  Â  AppState.bins.forEach((binData, binId) => {
Â  Â  Â  Â  Â  Â  const binTotal = Array.from(binData.items.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
Â  Â  Â  Â  Â  Â  binsTotal += binTotal;
Â  Â  Â  Â  Â  Â  const binEl = binArea.querySelector(`.bin[data-bin-id="${binId}"]`);
Â  Â  Â  Â  Â  Â  if (binEl) {
Â  Â  Â  Â  Â  Â  Â  Â  const titleEl = binEl.querySelector('h3');
Â  Â  Â  Â  Â  Â  Â  Â  if (titleEl){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtnHTML = titleEl.querySelector('.delete-bin-btn')?.outerHTML || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleEl.innerHTML = `${binData.name} <span class="item-count">${binTotal}</span> ${deleteBtnHTML}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  binAreaTitle.innerHTML = `åˆ†ç®±å·¥ä½œå€ <span class="item-count">${binsTotal}</span>`;
Â  Â  }

Â  Â  function moveItem(itemCode, sourceId, targetId, quantityToMove) {
Â  Â  Â  Â  const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId)?.items;
Â  Â  Â  Â  const targetMap = (targetId === 'pool') ? AppState.pool : AppState.bins.get(targetId)?.items;
Â  Â  Â  Â  if (!sourceMap || !targetMap || !sourceMap.has(itemCode)) { return; }
Â  Â  Â  Â  const itemToMove = sourceMap.get(itemCode);
Â  Â  Â  Â  const existingTargetItem = targetMap.get(itemCode);
Â  Â  Â  Â  if (existingTargetItem) {
Â  Â  Â  Â  Â  Â  existingTargetItem.quantity += quantityToMove;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  targetMap.set(itemCode, { ...itemToMove, quantity: quantityToMove });
Â  Â  Â  Â  }
Â  Â  Â  Â  itemToMove.quantity -= quantityToMove;
Â  Â  Â  Â  if (itemToMove.quantity <= 0) {
Â  Â  Â  Â  Â  Â  sourceMap.delete(itemCode);
Â  Â  Â  Â  }
Â  Â  Â  Â  render();
Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  }
Â  Â Â 
Â  Â  function returnItemsToPool(items) {
Â  Â  Â  Â  items.forEach(itemToReturn => {
Â  Â  Â  Â  Â  Â  const existingPoolItem = AppState.pool.get(itemToReturn.code);
Â  Â  Â  Â  Â  Â  if (existingPoolItem) {
Â  Â  Â  Â  Â  Â  Â  Â  existingPoolItem.quantity += itemToReturn.quantity;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  AppState.pool.set(itemToReturn.code, { ...itemToReturn });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function reIndexBins() {
Â  Â  Â  Â  const newBins = new Map();
Â  Â  Â  Â  let newCounter = 1;
Â  Â  Â  Â  const sortedBinArray = Array.from(AppState.bins.entries()).sort((a, b) => parseInt(a[0].split('-')[1]) - parseInt(b[0].split('-')[1]));
Â  Â  Â  Â  sortedBinArray.forEach(([oldBinId, binData]) => {
Â  Â  Â  Â  Â  Â  const newBinId = `bin-${newCounter}`;
Â  Â  Â  Â  Â  Â  binData.name = `ç¬¬ ${newCounter} ç®±`;
Â  Â  Â  Â  Â  Â  newBins.set(newBinId, binData);
Â  Â  Â  Â  Â  Â  newCounter++;
Â  Â  Â  Â  });
Â  Â  Â  Â  AppState.bins = newBins;
Â  Â  Â  Â  binCounter = newBins.size;
Â  Â  }
Â  Â Â 
Â  Â  function showQuantityModal(item, sourceId, targetId) {
Â  Â  Â  Â  modalItemName.textContent = item.name;
Â  Â  Â  Â  modalQuantityInput.value = item.quantity;
Â  Â  Â  Â  modalQuantityInput.max = item.quantity;
Â  Â  Â  Â  quantityModal.style.display = 'flex';
Â  Â  Â  Â  modalQuantityInput.focus();
Â  Â  Â  Â  modalCallback = (amount) => {
Â  Â  Â  Â  Â  Â  moveItem(item.code, sourceId, targetId, amount);
Â  Â  Â  Â  Â  Â  modalCallback = null;
Â  Â  Â  Â  };
Â  Â  }

Â  Â  function hideQuantityModal() {
Â  Â  Â  Â  quantityModal.style.display = 'none';
Â  Â  Â  Â  modalCallback = null;
Â  Â  }

Â  Â  function showChoiceModal(results, quantityToMove, sourceId, targetId) {
Â  Â  Â  Â  choiceList.innerHTML = '';
Â  Â  Â  Â  results.forEach(item => {
Â  Â  Â  Â  Â  Â  const choiceEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  choiceEl.className = 'choice-item';
Â  Â  Â  Â  Â  Â  choiceEl.innerHTML = `<strong>${item.name}</strong><div class="details">(ç·¨è™Ÿ: ${item.code})</div>`;
Â  Â  Â  Â  Â  Â  choiceEl.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  hideChoiceModal();
Â  Â  Â  Â  Â  Â  Â  Â  const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId).items;
Â  Â  Â  Â  Â  Â  Â  Â  const selectedItem = sourceMap.get(item.code);
Â  Â  Â  Â  Â  Â  Â  Â  if (quantityToMove > selectedItem.quantity) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`ç§»å‹•æ•¸é‡ (${quantityToMove}) è¶…éæ‰€é¸å•†å“å‰©é¤˜æ•¸é‡ (${selectedItem.quantity})ï¼`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  moveItem(item.code, sourceId, targetId, quantityToMove);
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`å·²å°æ‚¨é¸æ“‡çš„ "${item.name}" åŸ·è¡Œæ“ä½œã€‚`, 'success');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  choiceList.appendChild(choiceEl);
Â  Â  Â  Â  });
Â  Â  Â  Â  choiceModal.style.display = 'flex';
Â  Â  }

Â  Â  function hideChoiceModal() {
Â  Â  Â  Â  choiceModal.style.display = 'none';
Â  Â  Â  Â  choiceList.innerHTML = '';
Â  Â  }

Â  Â  function intelligentParse(rawLines) {
Â  Â  Â  Â  const poolMap = new Map();
Â  Â  Â  Â  const isNumeric = (str) => str && !isNaN(str) && !isNaN(parseFloat(str));
Â  Â  Â  Â  const headers = new Set(["å•†å“ç·¨è™Ÿ", "åœ‹éš›æ¢ç¢¼", "å“é …åç¨±", "æ•¸é‡", "æ’¿å®Œå‰©"]);
Â  Â  Â  Â  let dataLines = rawLines.map(line => line.trim()).filter(line => line && line !== 'åœ–' && !headers.has(line));
Â  Â  Â  Â  let i = 0;Â 
Â  Â  Â  Â  while (i < dataLines.length) {
Â  Â  Â  Â  Â  Â  let item = null;
Â  Â  Â  Â  Â  Â  if (i + 4 < dataLines.length && !isNumeric(dataLines[i + 2]) && isNumeric(dataLines[i + 3]) && isNumeric(dataLines[i + 4])) {
Â  Â  Â  Â  Â  Â  Â  Â  item = { code: dataLines[i], barcode: dataLines[i + 1] || 'NA', name: dataLines[i + 2], quantity: parseInt(dataLines[i + 3]) || 0 };
Â  Â  Â  Â  Â  Â  Â  Â  i += 5;
Â  Â  Â  Â  Â  Â  } else if (i + 3 < dataLines.length && !isNumeric(dataLines[i + 1]) && isNumeric(dataLines[i + 2]) && isNumeric(dataLines[i + 3])) {
Â  Â  Â  Â  Â  Â  Â  Â  item = { code: dataLines[i], barcode: 'NA', name: dataLines[i + 1], quantity: parseInt(dataLines[i + 2]) || 0 };
Â  Â  Â  Â  Â  Â  Â  Â  i += 4;
Â  Â  Â  Â  Â  Â  } else { i++; }
Â  Â  Â  Â  Â  Â  if (item) {
Â  Â  Â  Â  Â  Â  Â  Â  if (poolMap.has(item.code)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  poolMap.get(item.code).quantity += item.quantity;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  poolMap.set(item.code, item);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return poolMap;
Â  Â  }

Â  Â  function clearAllData() {
Â  Â  Â  Â  if (confirm("æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼Œå°‡æœƒæ¸…ç©ºå¾…åˆ†ç®±å€ã€æ‰€æœ‰ç®±å­å’Œè¨‚å–®è™Ÿç¢¼ã€‚")) {
Â  Â  Â  Â  Â  Â  AppState.pool.clear();
Â  Â  Â  Â  Â  Â  AppState.bins.clear();
Â  Â  Â  Â  Â  Â  binCounter = 0;
Â  Â  Â  Â  Â  Â  orderNumberInput.value = '';
Â  Â  Â  Â  Â  Â  dataInput.value = '';
Â  Â  Â  Â  Â  Â  searchBox.value = '';
Â  Â  Â  Â  Â  Â  currentSearchTerm = '';
Â  Â  Â  Â  Â  Â  localStorage.removeItem('binningToolState_v72');
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  showToast("æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¸…é™¤ã€‚", 'success');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function quickAddBins() {
Â  Â  Â  Â  const numStr = prompt("è«‹è¼¸å…¥è¦ä¸€æ¬¡æ–°å¢çš„ç®±å­æ•¸é‡ï¼š", "5");
Â  Â  Â  Â  if (numStr === null) return;
Â  Â  Â  Â  const num = parseInt(numStr);
Â  Â  Â  Â  if (isNaN(num) || num <= 0 || num > 100) {
Â  Â  Â  Â  Â  Â  showToast("è«‹è¼¸å…¥ä¸€å€‹ 1 åˆ° 100 ä¹‹é–“çš„æœ‰æ•ˆæ•¸å­—ã€‚", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  for (let i = 0; i < num; i++) {
Â  Â  Â  Â  Â  Â  binCounter++;
Â  Â  Â  Â  Â  Â  const binId = `bin-${binCounter}`;
Â  Â  Â  Â  Â  Â  AppState.bins.set(binId, { name: `ç¬¬ ${binCounter} ç®±`, tracking: '', items: new Map() });
Â  Â  Â  Â  }
Â  Â  Â  Â  render();
Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  Â  Â  showToast(`å·²æˆåŠŸæ–°å¢ ${num} å€‹ç®±å­ã€‚`, 'success');
Â  Â  }

Â  Â  // --- äº‹ä»¶ç›£è½å™¨ç¶å®š ---
Â  Â  parseBtn.addEventListener('click', () => {
Â  Â  Â  Â  const parsedMap = intelligentParse(dataInput.value.trim().split('\n'));
Â  Â  Â  Â  if (parsedMap.size > 0) {
Â  Â  Â  Â  Â  Â  AppState.pool = parsedMap;
Â  Â  Â  Â  Â  Â  AppState.bins.clear();
Â  Â  Â  Â  Â  Â  binCounter = 0;
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  dataInput.value = '';
Â  Â  Â  Â  Â  Â  showToast('è³‡æ–™è§£ææˆåŠŸï¼', 'success');
Â  Â  Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast("è§£æå¤±æ•—ï¼è«‹æª¢æŸ¥è³‡æ–™æ ¼å¼ã€‚", 'error');
Â  Â  Â  Â  }
Â  Â  });
Â  Â  addBinBtn.addEventListener('click', () => {
Â  Â  Â  Â  binCounter++;
Â  Â  Â  Â  const binId = `bin-${binCounter}`;
Â  Â  Â  Â  AppState.bins.set(binId, { name: `ç¬¬ ${binCounter} ç®±`, tracking: '', items: new Map() });
Â  Â  Â  Â  render();
Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  });
Â  Â  clearDataBtn.addEventListener('click', clearAllData);
Â  Â  quickAddBinsBtn.addEventListener('click', quickAddBins);
Â  Â  searchBox.addEventListener('input', () => {
Â  Â  Â  Â  currentSearchTerm = searchBox.value.trim().toLowerCase();
Â  Â  Â  Â  render();
Â  Â  });
Â  Â  binArea.addEventListener('click', (e) => {
Â  Â  Â  Â  if (e.target.classList.contains('delete-bin-btn')) {
Â  Â  Â  Â  Â  Â  const binEl = e.target.closest('.bin');
Â  Â  Â  Â  Â  Â  if (!binEl) return;
Â  Â  Â  Â  Â  Â  const binId = binEl.dataset.binId;
Â  Â  Â  Â  Â  Â  const binData = AppState.bins.get(binId);
Â  Â  Â  Â  Â  Â  if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${binData.name}ã€å—ï¼Ÿ\n(ç®±å…§æ‰€æœ‰å•†å“å°‡æœƒè¢«ç§»å›å¾…åˆ†ç®±å€)`)) {
Â  Â  Â  Â  Â  Â  Â  Â  if (binData.items.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnItemsToPool(Array.from(binData.items.values()));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  AppState.bins.delete(binId);
Â  Â  Â  Â  Â  Â  Â  Â  reIndexBins();
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  Â  Â  saveStateToLocalStorage();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
Â  Â  document.addEventListener('dragstart', e => {
Â  Â  Â  Â  const itemEl = e.target.closest('.item');
Â  Â  Â  Â  if (itemEl) {
Â  Â  Â  Â  Â  Â  const itemInfo = { code: itemEl.dataset.code, source: itemEl.dataset.source };
Â  Â  Â  Â  Â  Â  e.dataTransfer.setData('application/json', JSON.stringify(itemInfo));
Â  Â  Â  Â  Â  Â  e.dataTransfer.effectAllowed = 'move';
Â  Â  Â  Â  Â  Â  setTimeout(() => itemEl.classList.add('dragging'), 0);
Â  Â  Â  Â  }
Â  Â  });
Â  Â  document.addEventListener('dragend', e => { const el = e.target.closest('.item'); if(el) el.classList.remove('dragging'); });
Â  Â  document.addEventListener('dragover', e => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const targetBin = e.target.closest('.bin');
Â  Â  Â  Â  const targetPool = e.target.closest('#item-list-content');
Â  Â  Â  Â  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
Â  Â  Â  Â  itemListContent.style.borderColor = 'transparent';
Â  Â  Â  Â  if (targetBin) { targetBin.classList.add('drag-over'); }
Â  Â  Â  Â  if (targetPool) { itemListContent.style.borderColor = '#007bff'; }
Â  Â  });
Â  Â  document.addEventListener('dragleave', e => {
Â  Â  Â  Â  const targetBin = e.target.closest('.bin');
Â  Â  Â  Â  const targetPool = e.target.closest('#item-list-content');
Â  Â  Â  Â  if(targetBin) targetBin.classList.remove('drag-over');
Â  Â  Â  Â  if(targetPool) itemListContent.style.borderColor = 'transparent';
Â  Â  });
Â  Â  document.addEventListener('drop', e => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
Â  Â  Â  Â  itemListContent.style.borderColor = 'transparent';
Â  Â  Â  Â  const targetBinEl = e.target.closest('.bin');
Â  Â  Â  Â  const targetPoolEl = e.target.closest('#item-list-content');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const itemInfo = JSON.parse(e.dataTransfer.getData('application/json'));
Â  Â  Â  Â  Â  Â  if (!itemInfo) return;
Â  Â  Â  Â  Â  Â  if (targetBinEl && itemInfo.source === 'pool') {
Â  Â  Â  Â  Â  Â  Â  Â  const targetBinId = targetBinEl.dataset.binId;
Â  Â  Â  Â  Â  Â  Â  Â  const itemData = AppState.pool.get(itemInfo.code);
Â  Â  Â  Â  Â  Â  Â  Â  if (!itemData) return;
Â  Â  Â  Â  Â  Â  Â  Â  if (itemData.quantity > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showQuantityModal(itemData, itemInfo.source, targetBinId);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moveItem(itemInfo.code, itemInfo.source, targetBinId, 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  else if (targetPoolEl && itemInfo.source !== 'pool') {
Â  Â  Â  Â  Â  Â  Â  Â  const sourceBinId = itemInfo.source;
Â  Â  Â  Â  Â  Â  Â  Â  const itemCode = itemInfo.code;
Â  Â  Â  Â  Â  Â  Â  Â  const sourceBinMap = AppState.bins.get(sourceBinId)?.items;
Â  Â  Â  Â  Â  Â  Â  Â  if (!sourceBinMap || !sourceBinMap.has(itemCode)) return;
Â  Â  Â  Â  Â  Â  Â  Â  const itemData = sourceBinMap.get(itemCode);
Â  Â  Â  Â  Â  Â  Â  Â  moveItem(itemData.code, sourceBinId, 'pool', itemData.quantity);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) { console.error("æ‹–æ›³è³‡æ–™è§£æå¤±æ•—:", err); }
Â  Â  });
Â  Â Â 
Â  Â  function handleModalConfirm() {
Â  Â  Â  Â  const amount = parseInt(modalQuantityInput.value);
Â  Â  Â  Â  const maxAmount = parseInt(modalQuantityInput.max);
Â  Â  Â  Â  if (amount > 0 && amount <= maxAmount && modalCallback) {
Â  Â  Â  Â  Â  Â  modalCallback(amount);
Â  Â  Â  Â  Â  Â  hideQuantityModal();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast(`è«‹è¼¸å…¥ 1 åˆ° ${maxAmount} ä¹‹é–“çš„æœ‰æ•ˆæ•¸é‡ï¼`, 'error');
Â  Â  Â  Â  }
Â  Â  }
Â  Â  modalConfirmBtn.addEventListener('click', handleModalConfirm);
Â  Â  modalQuantityInput.addEventListener('keydown', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  handleModalConfirm();
Â  Â  Â  Â  }
Â  Â  });
Â  Â  modalCancelBtn.addEventListener('click', hideQuantityModal);
Â  Â  choiceCancelBtn.addEventListener('click', hideChoiceModal);

Â  Â  // --- å¿«é€ŸæŒ‡ä»¤ ---
Â  Â  function processCommand(commandText) {
Â  Â  Â  Â  const tokens = commandText.trim().split(/\s+/).filter(Boolean);
Â  Â  Â  Â  if (tokens.length < 3) {
Â  Â  Â  Â  Â  Â  showToast("æŒ‡ä»¤æ ¼å¼éŒ¯èª¤ï¼è«‹æª¢æŸ¥æ ¼å¼ã€‚", 'error');
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }

Â  Â  Â  Â  let sourceId, targetId, searchTerm, quantityToMove;
Â  Â  Â  Â  const isNumeric = (str) => str !== null && str.trim() !== '' && !isNaN(str) && !isNaN(parseFloat(str));

Â  Â  Â  Â  const L1 = tokens[tokens.length - 1];
Â  Â  Â  Â  const L2 = tokens[tokens.length - 2];
Â  Â  Â  Â  const L3 = tokens.length >= 3 ? tokens[tokens.length - 3] : null;

Â  Â  Â  Â  if (tokens.length >= 4 && isNumeric(L1) && isNumeric(L2) && isNumeric(L3)) {
Â  Â  Â  Â  Â  Â  const fromBinNum = L2;
Â  Â  Â  Â  Â  Â  const toBinNum = L1;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  sourceId = `bin-${fromBinNum}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (toBinNum === '0') {
Â  Â  Â  Â  Â  Â  Â  Â  targetId = 'pool';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  targetId = `bin-${toBinNum}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (!AppState.bins.has(targetId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç®±è™Ÿ ${toBinNum}ï¼`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  quantityToMove = parseInt(L3);
Â  Â  Â  Â  Â  Â  searchTerm = tokens.slice(0, tokens.length - 3).join(' ');
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  else if (isNumeric(L1) && isNumeric(L2)) {
Â  Â  Â  Â  Â  Â  const toBinNum = L1;
Â  Â  Â  Â  Â  Â  sourceId = 'pool';
Â  Â  Â  Â  Â  Â  targetId = `bin-${toBinNum}`;
Â  Â  Â  Â  Â  Â  Â if (!AppState.bins.has(targetId)) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç®±è™Ÿ ${toBinNum}ï¼`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  quantityToMove = parseInt(L2);
Â  Â  Â  Â  Â  Â  searchTerm = tokens.slice(0, tokens.length - 2).join(' ');
Â  Â  Â  Â  }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  showToast("æŒ‡ä»¤æ ¼å¼ç„¡æ³•è­˜åˆ¥ï¼\nè«‹ä½¿ç”¨: (è© æ•¸ å»å‘ç®±) æˆ– (è© æ•¸ ä¾†æºç®± å»å‘ç®±/0)", "error");
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId)?.items;

Â  Â  Â  Â  if (!sourceMap) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¾†æºã€Œ${sourceId}ã€ï¼`, 'error'); return false; }
Â  Â  Â  Â  if (isNaN(quantityToMove) || quantityToMove <= 0) { showToast("æŒ‡ä»¤éŒ¯èª¤ï¼šæ•¸é‡å¿…é ˆæ˜¯æ­£æ•´æ•¸ã€‚", 'error'); return false; }
Â  Â  Â  Â  if (searchTerm.trim() === '') { showToast("æŒ‡ä»¤éŒ¯èª¤ï¼šæœå°‹é—œéµå­—ä¸èƒ½ç‚ºç©ºã€‚", 'error'); return false; }

Â  Â  Â  Â  const searchLower = searchTerm.toLowerCase();
Â  Â  Â  Â  const results = Array.from(sourceMap.values()).filter(item =>Â 
Â  Â  Â  Â  Â  Â  item.name.toLowerCase().includes(searchLower) ||Â 
Â  Â  Â  Â  Â  Â  item.code.toLowerCase().includes(searchLower) ||
Â  Â  Â  Â  Â  Â  (item.barcode && item.barcode.toLowerCase().includes(searchLower))
Â  Â  Â  Â  );
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (results.length === 0) {
Â  Â  Â  Â  Â  Â  showToast(`åœ¨ä¾†æº (${sourceId}) æ‰¾ä¸åˆ°ç¬¦åˆ "${searchTerm}" çš„å•†å“`, 'error');
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (results.length === 1) {
Â  Â  Â  Â  Â  Â  const targetItem = results[0];
Â  Â  Â  Â  Â  Â  if (quantityToMove > targetItem.quantity) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`ç§»å‹•æ•¸é‡ (${quantityToMove}) è¶…éç¾æœ‰æ•¸é‡ (${targetItem.quantity})`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  moveItem(targetItem.code, sourceId, targetId, quantityToMove);
Â  Â  Â  Â  Â  Â  showToast(`å·²å°‡ ${quantityToMove} å€‹ "${targetItem.name}" åŸ·è¡Œç§»å‹•ã€‚`, 'success');
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (results.length > 1) {
Â  Â  Â  Â  Â  Â  showToast(`ç™¼ç¾ ${results.length} å€‹ç¬¦åˆé …ç›®ï¼Œè«‹é¸æ“‡...`);
Â  Â  Â  Â  Â  Â  showChoiceModal(results, quantityToMove, sourceId, targetId);
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  return false;
Â  Â  }

Â  Â  executeCommandBtn.addEventListener('click', () => { if (processCommand(commandInput.value)) { commandInput.value = ''; } });
Â  Â  commandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); executeCommandBtn.click(); } });
Â  Â Â 
Â  Â  // --- åŒ¯å‡ºåŠŸèƒ½ ---
Â  Â  function setupExports() {
Â  Â  Â  Â  const exportBtn = document.getElementById('export-btn');
Â  Â  Â  Â  const exportA4PdfBtn = document.getElementById('export-a4-pdf-btn');
Â  Â  Â  Â  const exportA5PdfBtn = document.getElementById('export-a5-pdf-btn');
Â  Â  Â  Â  const exportThermalPdfBtn = document.getElementById('export-thermal-pdf-btn');

Â  Â  Â  Â  function generateExportFilename(extension) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const hh = String(now.getHours()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const mm = String(now.getMinutes()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const ss = String(now.getSeconds()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const orderNumber = orderNumberInput.value.trim() || 'NoOrder';
Â  Â  Â  Â  Â  Â  return `${orderNumber}_${hh}${mm}${ss}_packing_list${extension}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportCSV() {
Â  Â  Â  Â  Â  Â  if (AppState.bins.size === 0) { showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
Â  Â  Â  Â  Â  Â  const orderNumber = orderNumberInput.value.trim() || 'N/A';
Â  Â  Â  Â  Â  Â  let csvContent = "\uFEFF";
Â  Â  Â  Â  Â  Â  csvContent += "è¨‚å–®è™Ÿç¢¼,ç®±è™Ÿ,é‹å–®è™Ÿ,å•†å“ç·¨è™Ÿ,åœ‹éš›æ¢ç¢¼,å“é …åç¨±,æ•¸é‡\n";

Â  Â  Â  Â  Â  Â  const formatCsvField = (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (value === null || value === undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  let stringValue = String(value);
Â  Â  Â  Â  Â  Â  Â  Â  stringValue = stringValue.replace(/"/g, '""');
Â  Â  Â  Â  Â  Â  Â  Â  if (stringValue.search(/("|,|\n)/g) >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stringValue = `"${stringValue}"`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return stringValue;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  AppState.bins.forEach(binData => {
Â  Â  Â  Â  Â  Â  Â  Â  if (binData.items.size === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = [orderNumber, binData.name, binData.tracking, '', '', 'æ­¤ç®±ç„¡å•†å“', 0].map(formatCsvField).join(',');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csvContent += row + "\n";
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  binData.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderNumber, binData.name, binData.tracking,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.code, item.barcode, item.name, item.quantity
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ].map(formatCsvField).join(',');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csvContent += row + "\n";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.download = generateExportFilename('.csv');
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportA4PDF() {
Â  Â  Â  Â  Â  Â  if (AppState.bins.size === 0 && AppState.pool.size === 0) { showToast("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('export-a4-pdf-btn');
Â  Â  Â  Â  Â  Â  btn.disabled = true; btn.textContent = 'æº–å‚™é è¦½...';
Â  Â  Â  Â  Â  Â  const poolTotal = Array.from(AppState.pool.values()).reduce((sum, item) => sum + item.quantity, 0);
Â  Â  Â  Â  Â  Â  let binsTotal = 0;
Â  Â  Â  Â  Â  Â  AppState.bins.forEach(binData => { binsTotal += Array.from(binData.items.values()).reduce((sum, item) => sum + item.quantity, 0); });
Â  Â  Â  Â  Â  Â  const orderTotal = poolTotal + binsTotal;
Â  Â  Â  Â  Â  Â  const orderNumber = orderNumberInput.value.trim() || 'N/A';
Â  Â  Â  Â  Â  Â  const exportDate = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const printStyles = `<style>@media print { body { margin: 0; -webkit-print-color-adjust: exact; } } body{font-family:'Helvetica','Arial','Microsoft JhengHei',sans-serif;font-size:10px;}.pdf-container{margin:20px;}.pdf-header h1{font-size:24px;}.pdf-header p{font-size:12px;}table{width:100%;border-collapse:collapse;margin-top:10px;}th,td{border:1px solid #ddd;padding:6px;text-align:left;word-break:break-all;}th{background-color:#f8f8f8;}.pdf-bin{page-break-inside:avoid; margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;}</style>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let contentHTML = `<div class="pdf-container"><div class="pdf-header"><h1>åˆ†ç®±æ˜ç´°ç¸½è¡¨</h1><p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p><p><strong>åŒ¯å‡ºæ—¥æœŸ:</strong> ${exportDate}</p><p><strong>è¨‚å–®ç¸½æ•¸:</strong> ${orderTotal}</p></div>`;
Â  Â  Â  Â  Â  Â  const totalBins = AppState.bins.size;
Â  Â  Â  Â  Â  Â  Array.from(AppState.bins.values()).forEach((binData, binIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  const newTitle = `ç¬¬ ${totalBins}-${binIndex + 1} ç®±`;
Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="pdf-bin"><h2>${newTitle}</h2><p><strong>é‹å–®è™Ÿ:</strong> ${binData.tracking || 'æœªå¡«å¯«'}</p><table><thead><tr><th>å“é …åç¨±</th><th>å•†å“ç·¨è™Ÿ</th><th>åœ‹éš›æ¢ç¢¼</th><th>æ•¸é‡</th></tr></thead><tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â  if (binData.items.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  binData.items.forEach(item => { contentHTML += `<tr><td>${item.name}</td><td>${item.code}</td><td>${item.barcode}</td><td>${item.quantity}</td></tr>`; });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<tr><td colspan="4" style="text-align:center;">æ­¤ç®±ç„¡å•†å“</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `</tbody></table></div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  contentHTML += '</div>';

Â  Â  Â  Â  Â  Â  const printWindow = window.open('', '_blank');
Â  Â  Â  Â  Â  Â  if (!printWindow) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("ç„¡æ³•æ‰“é–‹é è¦½è¦–çª—ï¼Œè«‹æª¢æŸ¥å½ˆå‡ºè¦–çª—æ˜¯å¦è¢«å°é–ã€‚", "error");
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A4ç¸½è¡¨)';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  printWindow.document.write(`<!DOCTYPE html><html lang="zh-Hant"><head><title>A4åˆ†ç®±ç¸½è¡¨ - ${orderNumber}</title>${printStyles}</head><body>${contentHTML}</body></html>`);
Â  Â  Â  Â  Â  Â  printWindow.document.close();
Â  Â  Â  Â  Â  Â  setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A4ç¸½è¡¨)';
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportA5BoxLabelsPDF() {
Â  Â  Â  Â  Â  Â  if (AppState.bins.size === 0) { showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('export-a5-pdf-btn');
Â  Â  Â  Â  Â  Â  btn.disabled = true; btn.textContent = 'æº–å‚™é è¦½...';
Â  Â  Â  Â  Â  Â  const orderNumber = orderNumberInput.value.trim() || 'N/A';
Â  Â  Â  Â  Â  Â  const printStyles = `<style>@media print{body{margin:0;-webkit-print-color-adjust:exact}}*{box-sizing:border-box}body{font-family:'Helvetica','Arial','Microsoft JhengHei',sans-serif}.a5-label-page{width:210mm;height:132.5mm;padding:7mm;page-break-after:always;border:1px dashed #ccc;margin:10mm auto}.a5-label-page:last-child{page-break-after:auto}.header,.footer{text-align:center}.header h1{margin:0 0 5px 0;font-size:26px}.header p{margin:0;font-size:16px}.content{margin-top:5px}.content table{width:100%;border-collapse:collapse}.content th,.content td{border:1px solid #ccc;padding:3px;text-align:left;font-size:12px;line-height:1.2}.content th{background-color:#f2f2f2}.footer{margin-top:15px;padding-top:8px}.footer p{font-size:14px;margin:3px 0}.footer-table{display:inline-table;text-align:left;font-size:16px;margin-top:5px}.footer-table td{padding:3px 5px}</style>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let contentHTML = ``;
Â  Â  Â  Â  Â  Â  const binsArray = Array.from(AppState.bins.values());
Â  Â  Â  Â  Â  Â  const totalBins = binsArray.length;
Â  Â  Â  Â  Â  Â  binsArray.forEach((binData, binIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemsArray = Array.from(binData.items.values());
Â  Â  Â  Â  Â  Â  Â  Â  const binTotal = itemsArray.reduce((s, i) => s + i.quantity, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const chunkSize = 10;
Â  Â  Â  Â  Â  Â  Â  Â  const totalPagesForBin = Math.max(1, Math.ceil(itemsArray.length / chunkSize));
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < totalPagesForBin; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemChunk = itemsArray.slice(i * chunkSize, (i + 1) * chunkSize);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newTitle = `ç¬¬ ${totalBins}-${binIndex + 1} ç®± <span style="font-size: 60%;">(${i + 1}/${totalPagesForBin})</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const footerHTML = `<div class="footer"><p><strong>æœ¬ç®±ç¸½æ•¸: ${binTotal} ä»¶</strong></p><table class="footer-table"><tbody><tr><td><strong>é‹å–®è™Ÿ:</strong></td><td>${binData.tracking || '___________________'}</td></tr><tr><td><strong>ç°½æ”¶:</strong></td><td>___________________</td></tr></tbody></table></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="a5-label-page"><div class="header"><h1>${newTitle}</h1><p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p></div><div class="content"><table><thead><tr><th style="width:80%">å“é …åç¨±</th><th>æ•¸é‡</th></tr></thead><tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemChunk.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemChunk.forEach(item => { contentHTML += `<tr><td>${item.name}</td><td style="text-align:center">${item.quantity}</td></tr>`; });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<tr><td colspan="2" style="text-align:center;height:50mm">æ­¤ç®±ç„¡å•†å“</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `</tbody></table></div>${footerHTML}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const printWindow = window.open('', '_blank');
Â  Â  Â  Â  Â  Â  if (!printWindow) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("ç„¡æ³•æ‰“é–‹é è¦½è¦–çª—ï¼Œè«‹æª¢æŸ¥å½ˆå‡ºè¦–çª—æ˜¯å¦è¢«å°é–ã€‚", "error");
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A5ç®±è²¼)';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  printWindow.document.write(`<!DOCTYPE html><html lang="zh-Hant"><head><title>åˆ—å°ç®±è²¼ - ${orderNumber}</title>${printStyles}</head><body>${contentHTML}</body></html>`);
Â  Â  Â  Â  Â  Â  printWindow.document.close();
Â  Â  Â  Â  Â  Â  setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º PDF (A5ç®±è²¼)';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
        // ===================================================================================
        // === æ™ºæ…§è¨ˆç®—ç†±æ„Ÿç´™åŒ¯å‡ºå‡½å¼ (é–‹å§‹) ===
        // ===================================================================================
Â  Â  Â  Â  function exportThermalLabelsPDF() {
Â  Â  Â  Â  Â  Â  if (AppState.bins.size === 0) { showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('export-thermal-pdf-btn');
Â  Â  Â  Â  Â  Â  btn.disabled = true; btn.textContent = 'æº–å‚™é è¦½...';
Â  Â  Â  Â  Â  Â  const orderNumber = orderNumberInput.value.trim() || 'N/A';

            // --- æ™ºæ…§è¨ˆç®—æ ¸å¿ƒé‚è¼¯ ---
            // é€™äº›æ˜¯åŸºæ–¼ CSS æ¨£å¼çš„ä¼°ç®—å€¼ï¼Œå–®ä½ç‚º mmã€‚å¦‚æœèª¿æ•´äº† CSSï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹é€™è£¡ã€‚
            const LABEL_TOTAL_HEIGHT_MM = 140; // æ¨™ç±¤å…§å®¹å¯ç”¨ç¸½é«˜åº¦ (150mm ç´™å¼µé«˜åº¦ - 5mm*2 é‚Šè·)
            const HEADER_ESTIMATED_HEIGHT_MM = 20; // é é¦–çš„ä¼°è¨ˆé«˜åº¦
            const FOOTER_ESTIMATED_HEIGHT_MM = 15; // é å°¾çš„ä¼°è¨ˆé«˜åº¦
            const ITEM_ROW_HEIGHT_MM = 7; // å–®ä¸€å“é …åˆ—çš„ä¼°è¨ˆé«˜åº¦ (åŒ…å«å…§è·)

            // è¨ˆç®—å¯å®¹ç´å“é …çš„å¯¦éš›ç©ºé–“
            const availableContentHeight = LABEL_TOTAL_HEIGHT_MM - HEADER_ESTIMATED_HEIGHT_MM - FOOTER_ESTIMATED_HEIGHT_MM;
            
            // å‹•æ…‹è¨ˆç®—æ¯é å¯ä»¥å®¹ç´çš„å“é …æ•¸ (chunkSize)
            const chunkSize = Math.floor(availableContentHeight / ITEM_ROW_HEIGHT_MM);
            // --- æ™ºæ…§è¨ˆç®—æ ¸å¿ƒé‚è¼¯çµæŸ ---

Â  Â  Â  Â  Â  Â  const printStyles = `<style>
Â  Â  Â  Â  Â  Â  Â  Â  @page {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 100mm 150mm;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin: 5mm;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  * { box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  Â  Â  body { font-family: 'Helvetica', 'Arial', 'Microsoft JhengHei', sans-serif; }
Â  Â  Â  Â  Â  Â  Â  Â  .thermal-label {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width: 90mm;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height: 140mm;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding: 3mm;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  page-break-after: always;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: 1px dashed #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin: 5mm auto;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  .thermal-label:last-child { page-break-after: auto; }
Â  Â  Â  Â  Â  Â  Â  Â  .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; }
Â  Â  Â  Â  Â  Â  Â  Â  .header h1 { margin: 0 0 5px 0; font-size: 24pt; }
Â  Â  Â  Â  Â  Â  Â  Â  .header p { margin: 0; font-size: 12pt; }
Â  Â  Â  Â  Â  Â  Â  Â  .content { flex-grow: 1; margin-top: 5px; overflow: hidden; }
Â  Â  Â  Â  Â  Â  Â  Â  /* ä¿®æ­£1ï¼šè®“è¡¨æ ¼ä½ˆå±€å›ºå®šï¼Œä»¥éµå®ˆè¡¨é ­çš„å¯¬åº¦è¨­å®š */
Â  Â  Â  Â  Â  Â  Â  Â  .content table { width: 100%; border-collapse: collapse; table-layout: fixed; }
Â  Â  Â  Â  Â  Â  Â  Â  .content th, .content td { border: 1px solid #999; padding: 4px; text-align: left; font-size: 10pt; line-height: 1.3; }
Â  Â  Â  Â  Â  Â  Â  Â  /* ä¿®æ­£2ï¼šé‡å°å“é …åç¨±æ¬„ä½ï¼ˆç¬¬ä¸€å€‹tdï¼‰ï¼Œå¼·åˆ¶ä¸æ›è¡Œä¸¦åœ¨æº¢å‡ºæ™‚é¡¯ç¤ºçœç•¥è™Ÿï¼Œç¢ºä¿è¡Œé«˜å›ºå®š */
Â  Â  Â  Â  Â  Â  Â  Â  .content td:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  Â  Â  Â  Â  Â  Â  .content th { background-color: #f2f2f2; }
Â  Â  Â  Â  Â  Â  Â  Â  .footer { border-top: 2px solid #000; padding-top: 5px; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â  .footer p { font-size: 12pt; margin: 3px 0; font-weight: bold; }
Â  Â  Â  Â  Â  Â  Â  Â  .footer .tracking-number { font-size: 11pt; margin-top: 5px; }
Â  Â  Â  Â  Â  Â  </style>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let contentHTML = ``;
Â  Â  Â  Â  Â  Â  const binsArray = Array.from(AppState.bins.values());
Â  Â  Â  Â  Â  Â  const totalBins = binsArray.length;
Â  Â  Â  Â  Â  Â  binsArray.forEach((binData, binIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemsArray = Array.from(binData.items.values());
Â  Â  Â  Â  Â  Â  Â  Â  const binTotal = itemsArray.reduce((s, i) => s + i.quantity, 0);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // ç¾åœ¨ totalPagesForBin æœƒä½¿ç”¨ä¸Šé¢æ™ºæ…§è¨ˆç®—å‡ºçš„ chunkSize
Â  Â  Â  Â  Â  Â  Â  Â  const totalPagesForBin = Math.max(1, Math.ceil(itemsArray.length / chunkSize));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < totalPagesForBin; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemChunk = itemsArray.slice(i * chunkSize, (i + 1) * chunkSize);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newTitle = `ç¬¬ ${totalBins}-${binIndex + 1} ç®±`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pageInfo = `(${i + 1}/${totalPagesForBin})`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="thermal-label">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1>${newTitle} <span style="font-size: 60%;">${pageInfo}</span></h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="content"><table><thead><tr><th style="width:80%">å“é …åç¨±</th><th style="text-align:center;">æ•¸é‡</th></tr></thead><tbody>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemChunk.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemChunk.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<tr><td>${item.name}</td><td style="text-align:center;">${item.quantity}</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<tr><td colspan="2" style="text-align:center;height:100mm;">æ­¤ç®±ç„¡å•†å“</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `</tbody></table></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>æœ¬ç®±ç¸½è¨ˆ: ${binTotal} ä»¶</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="tracking-number">é‹å–®è™Ÿ: ${binData.tracking || '______________________'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const printWindow = window.open('', '_blank');
Â  Â  Â  Â  Â  Â  if (!printWindow) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("ç„¡æ³•æ‰“é–‹é è¦½è¦–çª—ï¼Œè«‹æª¢æŸ¥å½ˆå‡ºè¦–çª—æ˜¯å¦è¢«å°é–ã€‚", "error");
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  printWindow.document.write(`<!DOCTYPE html><html lang="zh-Hant"><head><title>åˆ—å°ç†±æ„Ÿæ‡‰æ¨™ç±¤ - ${orderNumber}</title>${printStyles}</head><body>${contentHTML}</body></html>`);
Â  Â  Â  Â  Â  Â  printWindow.document.close();
Â  Â  Â  Â  Â  Â  setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.textContent = 'åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)';
Â  Â  Â  Â  }
        // ===================================================================================
        // === æ™ºæ…§è¨ˆç®—ç†±æ„Ÿç´™åŒ¯å‡ºå‡½å¼ (çµæŸ) ===
        // ===================================================================================

Â  Â  Â  Â  exportBtn.addEventListener('click', exportCSV);
Â  Â  Â  Â  exportA4PdfBtn.addEventListener('click', exportA4PDF);
Â  Â  Â  Â  exportA5PdfBtn.addEventListener('click', exportA5BoxLabelsPDF);
Â  Â  Â  Â  exportThermalPdfBtn.addEventListener('click', exportThermalLabelsPDF);
Â  Â  }
Â  Â  setupExports();
Â  Â Â 
Â  Â  function showToast(message, type = 'info') {
Â  Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  Â  toast.className = `toast-notification ${type}`;
Â  Â  Â  Â  toast.textContent = message;
Â  Â  Â  Â  document.body.appendChild(toast);
Â  Â  Â  Â  setTimeout(() => { toast.classList.add('show'); }, 10);
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  toast.classList.remove('show');
Â  Â  Â  Â  Â  Â  setTimeout(() => toast.remove(), 300);
Â  Â  Â  Â  }, 3000);
Â  Â  }
Â  Â Â 
Â  Â  function saveStateToLocalStorage() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const stateToSave = {
Â  Â  Â  Â  Â  Â  Â  Â  pool: Array.from(AppState.pool.entries()),
Â  Â  Â  Â  Â  Â  Â  Â  bins: Array.from(AppState.bins.entries()).map(([binId, binData]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [binId, { ...binData, items: Array.from(binData.items.entries()) }];
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  Â  Â  binCounter: binCounter,
Â  Â  Â  Â  Â  Â  Â  Â  orderNumber: orderNumberInput.value,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  localStorage.setItem('binningToolState_v72', JSON.stringify(stateToSave));
Â  Â  Â  Â  } catch (e) { console.error("ç„¡æ³•å„²å­˜ç‹€æ…‹:", e); }
Â  Â  }
Â  Â  function loadStateFromLocalStorage() {
Â  Â  Â  Â  const savedStateJSON = localStorage.getItem('binningToolState_v72');
Â  Â  Â  Â  if (!savedStateJSON) return;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const savedState = JSON.parse(savedStateJSON);
Â  Â  Â  Â  Â  Â  AppState.pool = new Map(savedState.pool);
Â  Â  Â  Â  Â  Â  AppState.bins = new Map(savedState.bins.map(([binId, binData]) => {
Â  Â  Â  Â  Â  Â  Â  Â  return [binId, { ...binData, items: new Map(binData.items) }];
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  binCounter = savedState.binCounter || 0;
Â  Â  Â  Â  Â  Â  orderNumberInput.value = savedState.orderNumber || '';
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  showToast("å·²æˆåŠŸè¼‰å…¥ä¸Šæ¬¡çš„é€²åº¦ã€‚", 'success');
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error("è¼‰å…¥ç‹€æ…‹å¤±æ•—:", e);
Â  Â  Â  Â  Â  Â  localStorage.removeItem('binningToolState_v72');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- åˆå§‹å‘¼å« ---
Â  Â  orderNumberInput.addEventListener('input', saveStateToLocalStorage);
Â  Â  document.addEventListener('DOMContentLoaded', loadStateFromLocalStorage);

</script>
</body>
</html>
